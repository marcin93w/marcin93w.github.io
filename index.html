<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iza &lt;3 Marcin</title>
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' 'unsafe-eval' blob: data: https://apis.google.com https://accounts.google.com https://content.googleapis.com https://www.gstatic.com https://ssl.gstatic.com;">
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script>
        let tokenClient;
        let accessToken = null;

        function initializeGapiClient() {
            return gapi.client.init({
                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
            });
        }

        function setupUpload() {
            const mediaUpload = document.getElementById('mediaUpload');
            const uploadBtn = document.getElementById('uploadBtn');

            gapi.load('client', initializeGapiClient);

            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: '600249699299-bpgdubq7iiie8rrbqps9vnit254hkfph.apps.googleusercontent.com',
                scope: 'https://www.googleapis.com/auth/drive.file',
                callback: (tokenResponse) => {
                    accessToken = tokenResponse.access_token;
                    // Upload after token is received
                    if (mediaUpload.files.length > 0) {
                        uploadFile(mediaUpload.files[0]);
                    }
                },
            });

            uploadBtn.addEventListener('click', function() {
                if (mediaUpload.files.length === 0) {
                    alert('Najpierw wybierz plik.');
                    return;
                }
                const file = mediaUpload.files[0];
                if (!(file.type.startsWith('image/') || file.type.startsWith('video/'))) {
                    alert('Proszę wybrać plik graficzny lub wideo.');
                    return;
                }
                if (!accessToken) {
                    // Must be called directly in the event handler!
                    tokenClient.requestAccessToken();
                } else {
                    uploadFile(file);
                }
            });

            function uploadFile(file) {
                const folderId = '1ChOSqybuVrN_mn4K7ZB8YqnkvMHSK7nv';
                const metadata = {
                    name: file.name,
                    mimeType: file.type,
                    parents: [folderId]
                };

                fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=resumable', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + accessToken,
                        'Content-Type': 'application/json; charset=UTF-8',
                        'X-Upload-Content-Type': file.type,
                        'X-Upload-Content-Length': file.size
                    },
                    body: JSON.stringify(metadata)
                }).then(res => {
                    if (!res.ok) throw new Error('Nie udało się zainicjować przesyłania.');
                    const uploadUrl = res.headers.get('Location');
                    return fetch(uploadUrl, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': file.type,
                            'Content-Length': file.size
                        },
                        body: file
                    });
                }).then(response => {
                    if (response.ok) {
                        alert('Plik został wysłany do Google Drive.');
                    } else {
                        alert('Wystąpił błąd podczas wysyłania pliku.');
                    }
                }).catch(error => {
                    console.error('Błąd: ' + JSON.stringify(error, null, 2));
                });
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            if (window.google && window.google.accounts && window.google.accounts.oauth2) {
                setupUpload();
            } else {
                const gisScript = document.querySelector('script[src*="gsi/client"]');
                gisScript.addEventListener('load', setupUpload);
            }
        });
    </script>
</head>
<body>
    <h1>Iza &lt;3 Marcin</h1>
    <form>
        <label for="mediaUpload">Wybierz zdjęcie lub wideo:</label>
        <input type="file" id="mediaUpload" name="mediaUpload" accept="image/*,video/*">
        <button type="button" id="uploadBtn">Wyślij plik</button>
    </form>
</body>
</html>